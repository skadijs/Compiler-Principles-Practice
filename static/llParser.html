<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LL(1) 语法分析器</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
    <link rel="stylesheet" href="/style.css">
</head>
<body class="page-ll">
    <div class="container">
        <header>
            <h1>LL(1) 语法分析器</h1>
        </header>

        <div class="main-content">
            <div class="editor-panel">
                <div class="panel-header">
                    <h3>源代码编辑器</h3>
                    <div class="controls">
                         <a href="/home.html" class="btn-secondary link-button">返回首页</a>
                        <button id="analyze-btn" class="btn-primary">分析代码</button>
                        <button id="clear-btn" class="btn-secondary">清空</button>
                    </div>
                </div>
                <textarea id="ll-editor" placeholder="请输入C语言代码...">
{               

while ( ID == NUM ) 

{ 

ID = NUM 

}

}
                </textarea>
            </div>

            <div class="panel results-panel">
                <div class="panel-header">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <h3>分析结果</h3>
                        <div id="loading" class="loading hidden" style="color: #ecf0f1; font-size: 0.9em;">分析中...</div>
                    </div>
                    <div class="controls">
                        <label style="cursor: pointer; display: flex; align-items: center; gap: 6px; user-select: none;">
                            <input type="checkbox" id="show-ast-chart"> 图形化展示
                        </label>
                    </div>
                </div>
                <div id="ll-errors" class="no-data hidden"></div>
                <pre id="ll-tree"></pre>
                <div id="ast-chart" style="width: 100%; height: 800px; display: none;"></div>
            </div>
        </div>

        <footer>
            <p>&copy;10235101565何冬语</p>
        </footer>
    </div>

    <script>
        const analyzeBtn = document.getElementById('analyze-btn');
        const clearBtn = document.getElementById('clear-btn');
        const llEditor = document.getElementById('ll-editor');
        const llTree = document.getElementById('ll-tree');
        const llErrors = document.getElementById('ll-errors');
        const loading = document.getElementById('loading');
        const showAstChart = document.getElementById('show-ast-chart');
        const astChartContainer = document.getElementById('ast-chart');
        let chartInstance = null;

        showAstChart.addEventListener('change', () => {
            if (showAstChart.checked) {
                llTree.style.display = 'none';
                astChartContainer.style.display = 'block';
                if (chartInstance) chartInstance.resize();
            } else {
                llTree.style.display = 'block';
                astChartContainer.style.display = 'none';
            }
        });

        window.addEventListener('resize', () => {
            if (chartInstance) chartInstance.resize();
        });

        analyzeBtn.addEventListener('click', async () => {
            const code = llEditor.value;
            if (!code.trim()) { alert('请输入C语言代码'); return; }
            try {
                loading.textContent = '分析中...';
                loading.classList.remove('hidden');
                analyzeBtn.disabled = true;
                const resp = await fetch('http://localhost:8080/llparse', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code })
                });
                if (!resp.ok) throw new Error('HTTP ' + resp.status);
                const data = await resp.json();
                llTree.textContent = data.tree || '';

                if (data.ast) {
                    if (!chartInstance) {
                        chartInstance = echarts.init(astChartContainer);
                    }
                    const option = {
                        tooltip: {
                            trigger: 'item',
                            triggerOn: 'mousemove'
                        },
                        series: [
                            {
                                type: 'tree',
                                data: [data.ast],
                                top: '1%',
                                left: '7%',
                                bottom: '1%',
                                right: '20%',
                                symbolSize: 7,
                                initialTreeDepth: -1,
                                roam: true,
                                label: {
                                    position: 'left',
                                    verticalAlign: 'middle',
                                    align: 'right',
                                    fontSize: 10
                                },
                                leaves: {
                                    label: {
                                        position: 'right',
                                        verticalAlign: 'middle',
                                        align: 'left'
                                    }
                                },
                                expandAndCollapse: true,
                                animationDuration: 550,
                                animationDurationUpdate: 750
                            }
                        ]
                    };
                    chartInstance.setOption(option);
                }

                const errs = [];
                if (data.syntaxError) errs.push('存在语法错误');
                if (data.missingSemicolon) errs.push('缺少分号，行号：' + data.missingLine);
                if (errs.length) {
                    llErrors.textContent = errs.join('；');
                    llErrors.classList.remove('hidden');
                } else {
                    llErrors.textContent = '';
                    llErrors.classList.add('hidden');
                }
                loading.textContent = '分析完成';
                setTimeout(() => loading.classList.add('hidden'), 300);
            } catch (e) {
                alert('分析失败: ' + e.message);
            } finally {
                analyzeBtn.disabled = false;
            }
        });

        clearBtn.addEventListener('click', () => {
            llEditor.value = '';
            llTree.textContent = '';
            llErrors.textContent = '';
            llErrors.classList.add('hidden');
        });
    </script>
</body>
</html>
